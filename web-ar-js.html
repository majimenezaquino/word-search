<!DOCTYPE html>
<html>
  <head>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  </head>
  <body style="margin : 0px; overflow: hidden;">
    <a-scene embedded arjs='sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;'>
      <a-marker type='barcode' value='1'>
        <!-- Objeto 3D inicial -->
        <a-box id="objeto3D" position="0 0.5 0" material="color: red;"></a-box>
      </a-marker>
      <a-entity camera></a-entity>
    </a-scene>
    
    <!-- Botón para activar la lectura del código QR -->
    <button id="leerQR" style="position: fixed; top: 10px; left: 10px;">Leer Código QR</button>

    <script>
    document.getElementById('leerQR').addEventListener('click', () => {
    leerCodigoQR().then(dataQR => {
        if(dataQR) {
            actualizarObjeto3D(dataQR);
        }
    });
});

async function leerCodigoQR() {
    return new Promise((resolve, reject) => {
        // Obtener acceso a la cámara
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
            .then(function(stream) {
                // Mostrar la transmisión de la cámara en el elemento video
                const video = document.createElement('video');
                video.srcObject = stream;
                video.play();

                // Esperar a que el video esté listo
                video.onloadedmetadata = function() {
                    // Crear un canvas para capturar un frame del video
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const context = canvas.getContext('2d');

                    // Dibujar el frame en el canvas
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);

                    // Obtener los datos de la imagen del canvas
                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);

                    // Usar jsQR para leer el código QR
                    const code = jsQR(imageData.data, imageData.width, imageData.height);

                    // Detener la transmisión de la cámara
                    stream.getTracks().forEach(track => track.stop());

                    if (code) {
                        resolve(code.data); // Retornar los datos del QR si se encontró uno
                    } else {
                        reject("No se pudo leer el código QR");
                    }
                };
            })
            .catch(err => {
                reject(err.message || "No se pudo acceder a la cámara");
            });
    });
}


function actualizarObjeto3D(datosQR) {
    // Lógica para cambiar el objeto 3D basado en los datos del QR
    // Por ejemplo, cambiar el color o la forma del objeto 3D
    const objeto3D = document.getElementById('objeto3D');
    objeto3D.setAttribute('material', 'color', datosQR === 'datos esperados' ? 'green' : 'blue');
}
</script>
  </body>
</html>
